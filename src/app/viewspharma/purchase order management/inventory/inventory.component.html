<div class="form-meta">
  <div class="header">
    <h2>INVENTORY ITEM</h2>
    <div>
      <span class="icons position-relative">
        <div class="btn-group">
          <button class="btn btn-outline-primary" [class.active]="uploadMode === 'single'" (click)="uploadMode = 'single'">Single Entry</button>
          <button class="btn btn-outline-success" [class.active]="uploadMode === 'bulk'" (click)="uploadMode = 'bulk'">Bulk Upload</button>
        </div>
        <i class="fa-solid fa-signal" [routerLink]="['/inventorylayout/inventorystocklist']" routerLinkActive="router-link-active"></i>
      </span>
    </div>
  </div>

  <div class="" *ngIf="userPermissions.create">
    <!-- Bulk Upload Form -->
    <div *ngIf="uploadMode === 'bulk'">
      <label>Import Medicine in Bulk (CSV):</label>
      <div class="d-flex align-items-center mt-3">
        <h5 class="mx-3">Sample Medicine CSV File</h5>
        <a href="https://digitalks-crm-bucket.s3.ap-south-1.amazonaws.com/HIMS/medicine_bulk_upload.csv" download>
          <i class="fa-solid fa-file-csv"></i>
        </a>
      </div>
      <div class="alert alert-info mt-2">
        <small><strong>CSV Format:</strong> medicine_name, supplier (vendor_id), dose, expiry_date, mfg_date, price, stock, maxStock, batch_no</small>
      </div>
      <input type="file" (change)="onFileSelected($event)" accept=".csv" class="form-control mt-3" />
      <div class="text-center mt-3">
        <button class="btn btn-dark mx-2" type="submit" (click)="uploadCSV()" [disabled]="!selectedFile">
          Submit
        </button>
      </div>
    </div>

    <!-- Single Entry Form -->
    <div *ngIf="uploadMode === 'single'">
      <form [formGroup]="medicineform" (ngSubmit)="onSubmit()">
        <div class="form-container">
          <div class="form-half">
            <div class="form-group">
              <label>Medicine Name <span class="required">*</span></label>
              <input type="text" class="form-control" placeholder="Medicine Name" formControlName="medicine_name" required />
              <div *ngIf="medicineform.get('medicine_name')?.touched && medicineform.get('medicine_name')?.invalid" class="text-danger">
                Medicine Name is Required
              </div>
            </div>

            <!-- Vendor Dropdown -->
            <div class="form-group">
              <label>Vendor/Supplier <span class="required">*</span></label>
              <select class="form-control" formControlName="supplier">
                <option value="">Select Vendor</option>
                <option *ngFor="let vendor of vendors" [value]="vendor._id">
                  {{ vendor.vendorName }}
                  <span *ngIf="vendor.contactPerson"> - {{ vendor.contactPerson }}</span>
                </option>
              </select>
              <div class="text-danger small" *ngIf="medicineform.get('supplier')?.invalid && medicineform.get('supplier')?.touched">
                Please select a vendor
              </div>

              <!-- Add New Vendor Link -->
              <!-- <div class="mt-2">
                <small>
                  <a href="/vendorlayout/vendormanagement" target="_blank" class="text-primary">
                    <i class="fa fa-plus"></i> Add New Vendor
                  </a>
                </small>
              </div> -->
            </div>

            <div class="form-group">
              <label>Dose <span class="required">*</span></label>
              <input type="number" formControlName="dose" class="form-control" min="0" placeholder="e.g., 500" />
              <div *ngIf="medicineform.get('dose')?.touched && medicineform.get('dose')?.invalid" class="text-danger">
                <span *ngIf="medicineform.get('dose')?.errors?.['required']">Dose is Required</span>
                <span *ngIf="medicineform.get('dose')?.errors?.['min']">Dose must be a positive number</span>
              </div>
            </div>

            <div class="form-group">
              <label>Batch Number <span class="required">*</span></label>
              <input type="text" class="form-control" formControlName="batch_no" placeholder="Batch Number" />
              <div *ngIf="medicineform.get('batch_no')?.touched && medicineform.get('batch_no')?.invalid" class="text-danger">
                Batch Number is Required
              </div>
            </div>
          </div>

          <div class="form-half">
            <div class="form-group">
              <label>Manufacturing Date <span class="required">*</span></label>
              <input type="date" class="form-control" formControlName="mfg_date" />
              <div *ngIf="medicineform.get('mfg_date')?.touched && medicineform.get('mfg_date')?.invalid" class="text-danger">
                Manufacturing Date is Required
              </div>
            </div>

            <div class="form-group">
              <label>Expiry Date <span class="required">*</span></label>
              <input type="date" class="form-control" formControlName="expiry_date" />
              <div *ngIf="medicineform.get('expiry_date')?.touched && medicineform.get('expiry_date')?.invalid" class="text-danger">
                Expiry Date is Required
              </div>
            </div>

            <div class="form-group">
              <label>Price <span class="required">*</span></label>
              <input type="number" class="form-control" formControlName="price" min="0" step="0.01" placeholder="Price per unit" />
              <div *ngIf="medicineform.get('price')?.touched && medicineform.get('price')?.invalid" class="text-danger">
                <span *ngIf="medicineform.get('price')?.errors?.['required']">Price is Required</span>
                <span *ngIf="medicineform.get('price')?.errors?.['min']">Price must be a positive number</span>
              </div>
            </div>

            <div class="form-group">
              <label>Maximum Stock <span class="required">*</span></label>
              <input type="number" class="form-control" formControlName="maxStock" min="1" placeholder="Maximum stock capacity" />
              <div *ngIf="medicineform.get('maxStock')?.touched && medicineform.get('maxStock')?.invalid" class="text-danger">
                <span *ngIf="medicineform.get('maxStock')?.errors?.['required']">Maximum Stock is Required</span>
                <span *ngIf="medicineform.get('maxStock')?.errors?.['min']">Maximum Stock must be at least 1</span>
              </div>
            </div>

            <div class="form-group">
              <label>Current Stock <span class="required">*</span></label>
              <input type="number" class="form-control" formControlName="stock" min="0" placeholder="Current stock quantity" />
              <div *ngIf="medicineform.get('stock')?.touched && medicineform.get('stock')?.invalid" class="text-danger">
                <span *ngIf="medicineform.get('stock')?.errors?.['required']">Stock is Required</span>
                <span *ngIf="medicineform.get('stock')?.errors?.['min']">Stock must be a positive number</span>
                <span *ngIf="medicineform.get('stock')?.errors?.['exceedsMaxStock']">Stock cannot exceed Maximum Stock</span>
              </div>

              <!-- Low Stock Warning -->
              <div *ngIf="medicineform.get('stock')?.value && medicineform.get('maxStock')?.value && (medicineform.get('stock')?.value <= medicineform.get('maxStock')?.value * 0.25)" class="alert alert-warning mt-2">
                <small><i class="fa fa-exclamation-triangle"></i> Low stock warning: Current stock is at 25% or below maximum capacity.</small>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions text-center mt-3">
          <button class="btn btn-dark mx-2" type="submit" >
            {{ editMode ? 'Update' : 'Submit' }}
          </button>
          <button class="btn btn-secondary" type="button" (click)="medicineform.reset()">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
