<div class="form-meta">
  <!-- Header Section -->
  <div class="header">
    <div>
      <h2>OUTPATIENT PHARMACY REQUISITION</h2>
    </div>
    <div>
      <button class="list-cases-btn mx-2"
        [routerLink]="['/master/medicinemasterlist']"
        routerLinkActive="router-link-active">
        MEDICINE PACKAGE
      </button>
      <span class="icons position-relative">
        <button class="toggle opd btn active mx-1"
          [routerLink]="['/doctor/opdpharmareq']"
          routerLinkActive="router-link-active">
          OPD
        </button>
        <button class="btn"
          [routerLink]="['/doctor/pharmareq']"
          routerLinkActive="router-link-active">
          IPD
        </button>
        <i class="fa-solid fa-user-tie mx-2"
           (click)="showUHIDDropdown = !showUHIDDropdown"></i>
        <i class="fa-solid fa-signal"
           [routerLink]="['/doctor/opdpharmareqlist']"
           routerLinkActive="router-link-active"></i>
        <!-- Dropdown -->
        <div *ngIf="showUHIDDropdown" class="dropdown-uhid-custom">
          <div *ngIf="uhidTodayRecords.length === 0"
               class="text-center text-muted py-2">
            No OPD Case created today.
          </div>
          <ul class="uhid-list">
            <li *ngFor="let record of uhidTodayRecords"
                (click)="selectPatientFromUHID(record)">
              <div class="uhid-name">
                {{ record?.uniqueHealthIdentificationId?.patient_name }}
              </div>
              <div class="uhid-meta">
                UHID: {{ record?.uniqueHealthIdentificationId?.uhid }} | Age: {{ record?.uniqueHealthIdentificationId?.age }}
              </div>
            </li>
          </ul>
        </div>
      </span>
    </div>
  </div>

  <div class="form-container" *ngIf="userPermissions.create">
    <!-- Main Form: Left Side -->
    <div class="form-half">
      <form [formGroup]="pharmareq" (ngSubmit)="OnSubmit()">
        <div class="form-row">
          <div class="form-group">
            <label>UHID No</label>
            <input type="text" class="form-control"
                   placeholder="Uhid No"
                   formControlName="caseNo"/>
            <div *ngIf="pharmareq.get('caseNo')?.invalid && pharmareq.get('caseNo')?.touched"
                 class="text-danger">
              Case No is required
            </div>
          </div>
          <div class="form-group">
            <label>Patient*:</label>
            <input type="text" class="input-text"
                   placeholder="Enter patient name"
                   formControlName="patient_name"
                   (input)="onPatientInput()"
                   (focus)="showSuggestions = true"
                   (blur)="hideSuggestionsWithDelay()"/>
            <div *ngIf="showSuggestions && filteredPatients.length > 0 && !editMode"
                 class="suggestions-container">
              <ul class="suggestions">
                <li *ngFor="let patient of filteredPatients"
                    (mousedown)="selectPatient(patient)">
                  {{ patient.patient_name }}
                  {{ patient.mobile_no ? "| " + patient.mobile_no : "" }}
                  {{ patient.uhid ? "| " + patient.uhid : "" }}
                </li>
              </ul>
            </div>
            <div *ngIf="pharmareq.get('patient_name')?.value?.length > 2 && !filteredPatients.length && !manuallySelected"
                 class="text-danger">
              No matching patients found
            </div>
            <div *ngIf="pharmareq.get('patient_name')?.touched && pharmareq.get('patient_name')?.invalid"
                 class="text-danger">
              Patient name is required
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Request For:</label>
          <div class="radio-group mx-3">
            <label><input type="radio" class="mx-3" name="requestForType"
                          formControlName="requestForType" value="Sales" checked/> Sales</label>
            <label><input type="radio" class="mx-3" name="requestForType"
                          formControlName="requestForType" value="Return"/> Return</label>
          </div>
        </div>
        <div class="form-group">
          <label>Bill Type:</label>
          <div class="radio-group mx-3">
            <label><input type="radio" class="mx-3" name="billtype"
                          value="card" formControlName="billtype" /> Card</label>
            <label><input type="radio" class="mx-3" name="billtype"
                          value="cash" formControlName="billtype" checked/> Cash</label>
            <label><input type="radio" class="mx-3" name="billtype"
                          value="cheque" formControlName="billtype" /> Cheque</label>
          </div>
        </div>
        <div class="">
          <div class="mb-3">
            <label for="medicineSearch" class="form-label fw-bold">Search Medicine</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fa-solid fa-search"></i>
              </span>
              <input id="medicineSearch" type="text" class="form-control form-control-lg"
                     [formControl]="medicineSearchControl"
                     placeholder="Type medicine name..."/>
            </div>
          </div>
          <div *ngIf="filteredMedicines.length > 0" class="mt-3">
            <h6 class="text-muted mb-2">
              Search Results ({{ filteredMedicines.length }} found)
            </h6>
            <div class="list-group" style="max-height: 300px; overflow-y: auto">
              <button *ngFor="let med of filteredMedicines"
                      type="button"
                      class="list-group-item list-group-item-action p-3"
                      (click)="selectMedicine(med)"
                      [class.list-group-item-secondary]="med.stock === 0"
                      [disabled]="med.stock === 0">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="mb-1 fw-bold" [class.text-muted]="med.stock === 0">
                      {{ med.medicine_name }}
                    </h6>
                    <div class="row g-0">
                      <div class="col-md-6">
                        <small class="text-muted">Price:</small>
                        <span class="fw-semibold text-success ms-1">â‚¹{{ med.price }}</span>
                      </div>
                      <div class="col-md-6">
                        <small class="text-muted">Stock:</small>
                        <span class="ms-1 fw-semibold"
                              [class.text-danger]="med.stock === 0"
                              [class.text-warning]="med.stock > 0 && med.stock <= 10"
                              [class.text-success]="med.stock > 10">
                          {{ med.stock }} units
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="ms-2">
                    <span *ngIf="med.stock === 0" class="badge bg-danger">Out of Stock</span>
                    <span *ngIf="med.stock > 0 && med.stock <= 10"
                          class="badge bg-warning text-dark">Low Stock</span>
                    <span *ngIf="med.stock > 10" class="badge bg-success">Available</span>
                  </div>
                </div>
              </button>
            </div>
          </div>
          <div *ngIf="medicineSearchControl.value && filteredMedicines.length === 0"
               class="alert alert-info mt-3">
            <i class="fa-solid fa-info-circle me-2"></i>
            No medicines found matching "{{ medicineSearchControl.value }}"
          </div>
          <div *ngIf="stockWarning" class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> Selected medicine is currently out of stock.
          </div>
        </div>
        <table class="table table-bordered table-hover align-middle diagnosis-table">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>MEDICINE NAME</th>
              <th>QTY</th>
              <th>Charge</th>
              <th></th>
            </tr>
          </thead>
          <tbody formArrayName="medicinesArray">
            <tr *ngFor="let row of medicinesArray.controls; let i = index"
                [formGroupName]="i">
              <td>{{ i + 1 }}</td>
              <td>
                <input type="text" class="form-control"
                       formControlName="medicine_name" readonly/>
              </td>
              <td>
                <input type="number" class="form-control"
                       formControlName="quantity"
                       [attr.max]="row.get('availableStock')?.value"
                       [attr.min]="1"
                       (change)="checkQuantity(i)"/>
              </td>
              <td>
                <input type="text" class="form-control"
                       formControlName="charge" readonly/>
              </td>
              <td>
                <button type="button"
                        class="btn btn-outline-danger btn-sm"
                        (click)="removeMedicineRow(i)">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="text-center mt-3">
          <button type="submit" class="btn btn-dark mx-2" [disabled]="pharmareq.invalid">Submit</button>
        </div>
      </form>
    </div>
    <!-- Right Side: Patient Info Section -->
    <div class="form-half">
      <div class="right-section">
        <div class="info-box" *ngIf="selectedPatient">
          <h5 style="color: darkred">Patient Details</h5>
          <hr/>
          <p>
            UHID Number:
            {{ selectedPatient?.uniqueHealthIdentificationId?.uhid || selectedPatient?.uhid }}
          </p>
          <p>
            Gender:
            {{ selectedPatient?.uniqueHealthIdentificationId?.gender || selectedPatient?.gender }}
          </p>
          <p>
            Age:
            {{ selectedPatient?.uniqueHealthIdentificationId?.age || selectedPatient?.age }}
          </p>
          <p>
            DOB:
            {{ selectedPatient?.uniqueHealthIdentificationId?.dob || selectedPatient?.dob | date }}
          </p>
          <p>
            Mobile Number:
            {{ selectedPatient?.uniqueHealthIdentificationId?.mobile_no || selectedPatient?.mobile_no }}
          </p>
        </div>
        <div *ngIf="!manuallySelected && filteredPatients.length === 0 && pharmareq.get('patient_name')?.value?.length > 2">
          <p>No patients found.</p>
        </div>
      </div>
    </div>
  </div>
</div>
