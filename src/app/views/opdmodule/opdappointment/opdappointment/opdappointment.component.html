<div class="form-meta">
  <!-- Header Section -->
  <div class="header">
    <h2>ADD NEW OPD APPOINTMENT DATA</h2>
    <span class="icons position-relative">
      <i
        class="fa-solid fa-user-tie mx-2"
        (click)="showUHIDDropdown = !showUHIDDropdown"
      ></i>
      <i
        class="fa-solid fa-signal"
        [routerLink]="['/opd/opdappointmentlist']"
        routerLinkActive="router-link-active"
      ></i>

      <!-- Dropdown -->
      <div *ngIf="showUHIDDropdown" class="dropdown-uhid-custom">
        <div
          *ngIf="uhidTodayRecords.length === 0"
          class="text-center text-muted py-2"
        >
          No UHID created today.
        </div>
        <ul class="uhid-list">
          <li
            *ngFor="let record of uhidTodayRecords"
            (click)="selectPatientFromUHID(record)"
            style="cursor: pointer"
          >
            <div class="uhid-name">{{ record.patient_name }}</div>
            <div class="uhid-meta">
              UHID: {{ record.uhid }} | Age: {{ record.age }}
            </div>
          </li>
        </ul>
      </div>
    </span>
  </div>

  <div class="form-container">
    <div class="form-half">
      <div class="form-container">
        <!-- Main Form: Left Side -->
        <div class="form-half">
          <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()">
            <!-- Patient Name and Case Type -->
            <div class="form-group">
              <label>Patient</label>
              <input
                type="text"
                class="form-control"
                placeholder="Enter patient name"
                formControlName="patient_name"
                (input)="onPatientInput()"
                (focus)="showSuggestions = true"
                (blur)="hideSuggestionsWithDelay()"
              />
              <div
                *ngIf="
                  showSuggestions && filteredPatients.length > 0 && !editMode
                "
                class="suggestion-container"
              >
                <ul class="suggestions">
                  <li
                    *ngFor="let patient of filteredPatients"
                    (mousedown)="selectPatient(patient)"
                  >
                    {{ patient.patient_name }}
                    {{ patient.mobile_no ? "| " + patient.mobile_no : "" }}
                    {{ patient.uhid ? "| " + patient.uhid : "" }}
                  </li>
                </ul>
              </div>
              <div
                *ngIf="
                  appointmentForm.get('patient_name')?.touched &&
                  appointmentForm.get('patient_name')?.invalid
                "
                class="text-danger"
              >
                Patient name is required
              </div>
            </div>
            <div class="form-group">
              <label>UHID</label>
              <div class="custom-select-wrapper">
                <select class="form-control" formControlName="caseType">
                  <option value="new">New</option>
                  <option value="old">Old</option>
                </select>
              </div>
            </div>

            <div
              class="form-group"
              *ngIf="appointmentForm.get('caseType')?.value === 'old'"
            >
              <label>UHID Number</label>
              <input
                type="text"
                class="form-control"
                placeholder="UHID"
                formControlName="uhid"
              />
            </div>

            <div class="form-group position-relative">
              <label>Consultant Dr.</label>
              <input
                type="text"
                class="form-control"
                placeholder="Search Doctor by Name"
                [formControl]="doctorSearchControl"
                (focus)="showDoctorSuggestions = true"
                (blur)="hideSuggestionsLater()"
              />
              <div class="suggestion-container">
                <ul
                  class="suggestions"
                  *ngIf="showDoctorSuggestions && filteredDoctors.length > 0"
                >
                  <li
                    class=""
                    *ngFor="let doc of filteredDoctors"
                    (mousedown)="selectDoctor(doc)"
                  >
                    {{ doc.name }}
                  </li>
                </ul>
              </div>
            </div>

            <div class="form-group">
              <label>Date *</label>
              <input type="date" class="form-control" formControlName="date" />
            </div>
            <div class="form-group">
              <label>Time *</label>
              <app-customappointmenttimepicker
                formControlName="time"
                (change)="onTimeChange($event)"
              ></app-customappointmenttimepicker>
            </div>

            <div class="form-group">
              <label>Gender:</label>
              <div class="radio-group">
                <label class="me-3">
                  <input type="radio" value="male" formControlName="gender" />
                  Male
                </label>
                <label>
                  <input type="radio" value="female" formControlName="gender" />
                  Female
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>DOB*</label>
              <input type="date" class="form-control" formControlName="dob" />
            </div>

            <div class="form-group">
              <label>Age</label>
              <input
                type="text"
                class="form-control"
                formControlName="age"
                readonly
              />
            </div>
            <div class="form-group">
              <label>Mobile No</label>
              <input
                type="text"
                class="form-control"
                formControlName="mobile_no"
                maxlength="10"
              />
            </div>
          </form>
        </div>

        <!-- Main Form: Right Side -->
        <div class="form-half">
          <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()">
            <div class="form-group mb-3">
              <label>Status</label>
              <div class="custom-select-wrapper">
                <select class="form-control" formControlName="status">
                  <option value="scheduled">Scheduled</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="reschedule">Reschedule</option>
                </select>
              </div>
              <div *ngIf="
                  appointmentForm.get('status')?.touched &&
                  appointmentForm.get('status')?.invalid
                " class="text-danger">
                Please enter Status
              </div>
            </div>

            <div class="form-group">
              <label>Remarks</label>
              <input
                type="text"
                class="form-control"
                formControlName="remarks"
              />
            </div>

            <div class="form-group">
              <label>Address</label>
              <textarea class="form-control" formControlName="area"></textarea>
            </div>
            <div class="form-group">
              <label>Pincode</label>
              <input
                type="text"
                class="form-control"
                formControlName="pincode"
                maxlength="6"
                (keypress)="allowOnlyNumbers($event)"
              />
            </div>

            <div class="form-group">
              <label>Payment Status</label>
              <input
                type="text"
                class="form-control"
                formControlName="payment_status"
                readonly
              />
            </div>
            <div class="form-group">
              <label>Queue Status</label>
              <div class="custom-select-wrapper">
                <select class="form-control" formControlName="queue_status">
                  <option value="waiting">Waiting</option>
                  <option value="called">Called</option>
                  <option value="skipped">Skipped</option>
                  <option value="done">Done</option>
                  <option value="not_assigned">Not Assigned</option>
                </select>
              </div>
              <div
                *ngIf="
                  appointmentForm.get('queue_status')?.touched &&
                  appointmentForm.get('queue_status')?.invalid
                "
                class="text-danger"
              >
                Please enter Queue Status
              </div>
            </div>

            <div class="form-group">
              <label>Source</label>
              <div class="custom-select-wrapper">
                <select class="form-control" formControlName="source">
                  <option value="walk-in">Walk-in</option>
                  <option value="staff-referral">Staff Referral</option>
                  <option value="doctor-referral">Doctor Referral</option>
                  <option value="online">Online</option>
                </select>
              </div>
              <div
                *ngIf="
                  appointmentForm.get('source')?.touched &&
                  appointmentForm.get('source')?.invalid
                "
                class="text-danger"
              >
                Please enter Source
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea
                class="form-control"
                formControlName="notes"
                rows="1"
              ></textarea>
            </div>

            <div
              class="form-group"
              *ngIf="appointmentForm.get('source')?.value === 'staff-referral'"
            >
              <label>Staff Id</label>
              <input
                type="text"
                class="form-control"
                formControlName="staffId"
                placeholder="Enter staff id"
              />
              <small
                class="text-danger"
                *ngIf="
                  appointmentForm.get('staffId')?.touched &&
                  appointmentForm.get('staffId')?.invalid
                "
              >
                Staff Id is required.
              </small>
            </div>
            <div
              class="form-group"
              *ngIf="appointmentForm.get('source')?.value === 'staff-referral'"
            >
              <label>Staff Name</label>
              <input
                type="text"
                class="form-control"
                formControlName="staff_name"
                placeholder="Staff name"
              />
            </div>

            <div
              class="form-group"
              *ngIf="appointmentForm.get('source')?.value === 'doctor-referral'"
            >
              <label>Referring Doctor Name</label>
              <input
                type="text"
                class="form-control"
                formControlName="doctor_name"
                placeholder="Enter doctor name"
              />
              <small
                class="text-danger"
                *ngIf="
                  appointmentForm.get('doctor_name')?.touched &&
                  appointmentForm.get('doctor_name')?.invalid
                "
              >
                Doctor name is required.
              </small>
            </div>

            <div
              class="form-group"
              *ngIf="appointmentForm.get('source')?.value === 'online'"
            >
              <label>Platform Name</label>
              <input
                type="text"
                class="form-control"
                formControlName="platform_name"
                placeholder="e.g. Facebook, Website"
              />
              <small
                class="text-danger"
                *ngIf="
                  appointmentForm.get('platform_name')?.touched &&
                  appointmentForm.get('platform_name')?.invalid
                "
              >
                Platform name is required.
              </small>
            </div>

            <div class="form-group">
              <label>Email:</label>
              <input type="email" formControlName="emailAddress" />
            </div>

            <!-- Actions -->
            <div class="form-actions">
              <button type="submit" [disabled]="appointmentForm.invalid">
                Save
              </button>
              <!-- <button type="button" class="btn-secondary" (click)="resetForm()">
                Cancel
              </button> -->
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="form-half">
      <!-- Right Section: Visit History and Available Slots -->
      <div class="form-container">
        <div class="right-section mx-2">
          <div class="info-box">
            <strong>VISIT HISTORY</strong>
            <div
              *ngIf="Filteredappointments.length > 0"
              class="mt-3"
              style="max-height: 500px; overflow-y: auto"
            >
              <table
                class="table table-bordered table-hover align-middle diagnosis-table"
              >
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Visit Date</th>
                    <th>Visit Time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let visit of Filteredappointments; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>{{ visit.date | date : "yyyy-MM-dd" }}</td>
                    <td>{{ getFormattedTime(visit.time) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="form-half">
          <div
            class="available-slots right-section"
            *ngIf="selectedDoctor && !reset"
            style="max-height: 300px; overflow-y: auto"
          >
            <div class="info-box sticky-top">
              <strong>AVAILABLE SLOTS - {{ selectedDate }}</strong>
              <hr>
              <div *ngIf="isLoadingSlots" class="loading-spinner">
                Loading time slots...
              </div>
              <div class="slot-grid" *ngIf="!isLoadingSlots">
                <button class="mx-1"
                  *ngFor="let time of freeSlots"
                  [disabled]="bookedSlots.includes(time)"
                  [ngClass]="{
                    'slot-button': true,
                    booked: bookedSlots.includes(time),
                    free: !bookedSlots.includes(time)
                  }"
                >
                  {{ time }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
