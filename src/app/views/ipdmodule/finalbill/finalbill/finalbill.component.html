<!-- <p>finalbill works!</p> -->

<div class="header">
  <h2>FINAL BILL</h2>
  <div class="">
    <button class="list-cases-btn mx-3"><i class="fa-solid fa-user-group"></i></button>
  </div>
</div>

<div class="opd-container">
  <form [formGroup]="finalbill" (ngSubmit)="OnSubmit()">
    <h4 class="m-4">Patient Details</h4>
    <hr>
    <div class="form-row">
            <div class="form-group">
        <label>Patient*:</label>
          <input
            type="text"
            class="input-text"
            placeholder="Enter patient name"
            formControlName="patient_name"
            (input)="onPatientInput()"
            (focus)="showSuggestions = true"
            (blur)="hideSuggestionsWithDelay()">
        <!-- </div> -->
        <!-- Patient Suggestions Dropdown - MOVED OUTSIDE BUT STILL IN THE FORM-GROUP -->
        <div *ngIf="showSuggestions && filteredPatients.length > 0" class="suggestions-container">
          <ul class="suggestions">
            <li *ngFor="let patient of filteredPatients" (mousedown)="selectPatient(patient)">
              {{ patient.patient_name }} {{ patient.mobile_no ? '| ' + patient.mobile_no : '' }} {{ patient.uhid ? '| ' + patient.uhid : '' }}
            </li>
          </ul>
        </div>

        <!-- Debug info - MODIFIED to check for manuallySelected flag -->
        <div *ngIf="finalbill.get('patient_name')?.value &&
                   finalbill.get('patient_name')?.value.length > 2 &&
                   !filteredPatients.length &&
                   !manuallySelected" class="text-danger">
          No matching patients found
        </div>
        <div *ngIf="finalbill.get('patient_name')?.touched && finalbill.get('patient_name')?.invalid" class="text-danger">
          Patient name is required
        </div>
      </div>
      <div class="form-group">
        <label>UHID No:</label>
        <input type="text" placeholder="UHID No" class="form-control required" formControlName="uhid">
        <div *ngIf="finalbill.get('uhid')?.invalid && finalbill.get('uhid')?.touched" class="error-message">
          UHID number is required.
        </div>
      </div>
      <div class="form-group">
        <label>Bill Amount:</label>
        <input type="number" placeholder="Bill No" class="form-control" formControlName="billamount">
        <div *ngIf="finalbill.get('billamount')?.invalid && finalbill.get('billamount')?.touched" class="error-message">
          Bill Amount is required.
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Address:</label>
        <input type="text" placeholder="Address" class="form-control" formControlName="area">
      </div>
      <div class="form-group">
        <label>Bed:</label>
        <input type="text" placeholder="Bed" class="form-control" formControlName="bedno">
        <div *ngIf="finalbill.get('bedno')?.invalid && finalbill.get('bedno')?.touched" class="error-message">
          Bed Number is required.
        </div>
      </div>
      <div class="form-group">
        <label>Received Amount:</label>
        <input type="text" placeholder="Received Amount" class="form-control" formControlName="receied_amount">
        <div *ngIf="finalbill.get('receied_amount')?.invalid && finalbill.get('receied_amount')?.touched" class="error-message">
         Amount is required.
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Age*:</label>
        <input type="text" placeholder="Age/Gender" class="form-control" formControlName="age">
        <div *ngIf="finalbill.get('age')?.invalid && finalbill.get('age')?.touched" class="error-message">
          Age is required.
         </div>
      </div>
      <div class="form-group">
        <label>DOA:</label>
        <!-- <app-customcalendar formControlName="doa"></app-customcalendar> -->
        <input type="date" name="" id="" formControlName="doa" class="form-control">
      </div>
      <div class="form-group">
        <label>Due Amount:</label>
        <input type="number" placeholder="Due Amount" class="form-control" formControlName="dueamount">
        <div *ngIf="finalbill.get('dueamount')?.invalid && finalbill.get('dueamount')?.touched" class="error-message">
          Due Amount is required.
         </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group" [ngClass]="{'is-invalid': finalbill.get('mobile_no')?.invalid && finalbill.get('mobile')?.touched}">
        <label>Mobile*:</label>
        <input type="text"
        formControlName="mobile_no"
        placeholder="Mobile No"
        maxlength="10"
        pattern="[6-9][0-9]{9}"
        title="Enter 10-digit mobile number starting with 6-9"
        (keypress)="allowOnlyNumbers($event)">
        <div class="text-danger small" *ngIf="finalbill.get('mobile_no')?.invalid && finalbill.get('mobile_no')?.touched">
          Enter valid 10-digit mobile number.
        </div>
      </div>
      <div class="form-group">
        <label>DOD</label>
        <!-- <app-customcalendar></app-customcalendar> -->
        <input type="date" name="" id="" formControlName="dod">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Cons. Doctor*:</label>
        <input type="text" placeholder="Cons. Doctor" class="form-control required" formControlName="cns_doc">
      </div>
      <div class="form-group">
        <label>Ref. Doctor</label>
        <input type="text" placeholder="Ref. Doctor" class="form-control" formControlName="ref_doc">
      </div>
    </div>

    <h4 class="m-4">Servcing Details</h4>
    <hr>

    <div class="form-row">
      <div class="form-group">
        <label>Sort By:</label>
        <select class="form-control w-25">
          <option value=""></option>
          <option value=""></option>
          <option value=""></option>
        </select>
      </div>
      <div class="form-group">
        <label>Filter Service:</label>
        <select class="form-control w-25">
          <option value=""></option>
          <option value=""></option>
          <option value=""></option>
        </select>
      </div>
    </div>

    <!-- <button class="btn btn-secondary w-25 text-center">Apply</button> -->
      <table class="table table-bordered table-hover align-middle diagnosis-table">
     <thead class="table-dark text-center" >
        <tr>
          <th>Service </th>
          <th>Doctor NAME</th>
          <th>Rate</th>
          <th>Qty</th>
          <th>Disc</th>
          <th>Net</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tbody>
    </table>

    <div class="text-center mt-3">
      <button class="btn btn-dark mx-2" [disabled]="finalbill.invalid">Submit</button>
      <button class="btn btn-secondary">Cancel</button>
    </div>
  </form>
</div>
